{
  "StartAt": "SetConstants",
  "States" : {
    "SetConstants": {
      "Type": "ExpressionEval",
      "Parameters": {
        "gcs_endpoint_id": "<INSERT YOUR GCS ENDPOINT ID HERE>",
        "compute_endpoint_id": "<INSERT YOUR COMPUTE ENDPOINT ID HERE>",
        "compute_func_id": "<INSERT YOUR COMPUTE FUNCTION ID HERE>",
        "compute_transform_from": "/",
        "compute_transform_to": "/",
        "compute_dest_path.=": "'/~/' + _context.run_id + '/'"
      },
      "ResultPath": "$.constants",
      "Next" : "MakeComputeWorkingDir"
    },
    "MakeComputeWorkingDir": {
      "Type": "Action",
      "ActionUrl": "https://transfer.actions.globus.org/mkdir",
      "Parameters": {
        "endpoint_id.$": "$.constants.gcs_endpoint_id",
        "path.$": "$.constants.compute_dest_path"
      },
      "ResultPath": "$.mkdir_result",
      "Next": "RunComputeFunction"
    },
    "RunComputeFunction": {
      "Type": "Action",
      "ActionUrl": "https://compute.actions.globus.org/v3",
      "Parameters": {
        "endpoint_id.$": "$.constants.compute_endpoint_id",
        "tasks": [
          {
            "function_id.$": "$.constants.compute_func_id",
            "args": [],
            "kwargs": {
              "src_path.$" : "$.source_path",
              "dest_path.$" : "$.constants.compute_dest_path",
              "transform_from.$": "$.constants.compute_transform_from",
              "transform_to.$": "$.constants.compute_transform_to"
            }
          }
        ]
      },
      "ResultPath": "$.compute_result",
      "Next" : "TransferFromComputeEndpoint"
    },
    "TransferFromComputeEndpoint": {
      "Type": "Action",
      "ActionUrl": "https://transfer.actions.globus.org/transfer",
      "Parameters": {
        "source_endpoint.$": "$.constants.gcs_endpoint_id",
        "destination_endpoint.$": "$.destination_endpoint_id",
        "DATA": [
          {
            "source_path.=": "compute_result.details.result[0]",
            "destination_path.$": "$.destination_path"
          }
        ]
      },
      "ResultPath": "$.transfer_to_dest_result",
      "Next" : "CleanupComputeEndpoint"
    },
    "CleanupComputeEndpoint": {
      "Type": "Action",
      "ActionUrl": "https://transfer.actions.globus.org/delete",
      "Parameters": {
        "endpoint.$": "$.constants.gcs_endpoint_id",
        "recursive": true,
        "DATA": [
          {
            "path.$": "$.constants.compute_dest_path"
          }
        ]
      },
      "ResultPath": "$.delete_compute_output_result",
      "End" : true
    }
  }
}